<!-- Plotly.js CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
    .controls {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .controls label {
        margin-right: 10px;
        font-weight: bold;
    }
    .controls input[type="text"],
    .controls select,
    .controls button {
        padding: 8px;
        margin-right: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .controls button {
        background-color: #007bff;
        color: white;
        cursor: pointer;
    }
    .controls button:hover {
        background-color: #0056b3;
    }
    #percentileResult {
        margin-top: 15px;
        font-size: 1.1em;
        font-weight: bold;
    }
    #loadingMessage, #errorMessage {
        margin-top: 10px;
        color: #777;
    }
    #errorMessage {
        color: red;
    }
</style>

<div class="controls">
    <label for="userTime">Your Time (HH:MM:SS):</label>
    <input type="text" id="userTime" placeholder="e.g., 01:45:30">

    <label for="genderFilter">Filter by Gender:</label>
    <select id="genderFilter">
        <option value="All">All</option>
        <option value="Men">Men</option>
        <option value="Women">Women</option>
    </select>

    <button onclick="updatePlot()">Update Plot</button>
    <div id="percentileResult"></div>
</div>

<div id="histogramPlot"></div>
<div id="loadingMessage">Loading results data...</div>
<div id="errorMessage"></div>

<script>
    let allResultsData = [];
    const plotDiv = document.getElementById('histogramPlot');
    const userTimeInput = document.getElementById('userTime');
    const genderFilterSelect = document.getElementById('genderFilter');
    const percentileResultDiv = document.getElementById('percentileResult');
    const loadingMessageDiv = document.getElementById('loadingMessage');
    const errorMessageDiv = document.getElementById('errorMessage');

    // Function to parse HH:MM:SS to minutes
    function parseTimeToMinutes(timeStr) {
        if (!timeStr) return null;
        const parts = timeStr.split(':');
        if (parts.length < 2 || parts.length > 3) return null; // Must be MM:SS or HH:MM:SS

        let hours = 0, minutes = 0, seconds = 0;

        if (parts.length === 3) { // HH:MM:SS
            hours = parseInt(parts[0], 10);
            minutes = parseInt(parts[1], 10);
            seconds = parseInt(parts[2], 10);
        } else if (parts.length === 2) { // MM:SS
            minutes = parseInt(parts[0], 10);
            seconds = parseInt(parts[1], 10);
        } else {
            return null; // Should not happen with previous check, but good for safety
        }

        if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return null;
        if (hours < 0 || minutes < 0 || minutes > 59 || seconds < 0 || seconds > 59) return null;

        return hours * 60 + minutes + seconds / 60;
    }

    // Fetch data and initialize
    async function fetchDataAndInitialize() {
        try {
            // Adjust the path if your Jekyll site structure puts assets elsewhere relative to the root
            // For `permalink: /gbgvarv/`, `assets/` should be relative to the site root.
            const response = await fetch('{{ "/assets/data/goteborgsvarvet_2025_results.json" | relative_url }}');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            allResultsData = await response.json();
            loadingMessageDiv.style.display = 'none';
            if (allResultsData.length === 0) {
                errorMessageDiv.textContent = "No results data found or data is empty.";
                return;
            }
            // Initial plot with all data
            updatePlot();
        } catch (error) {
            console.error("Error fetching or parsing data:", error);
            loadingMessageDiv.style.display = 'none';
            errorMessageDiv.textContent = `Error loading results: ${error.message}. Please ensure the JSON file is correctly placed and formatted.`;
        }
    }

    function updatePlot() {
        errorMessageDiv.textContent = ""; // Clear previous errors
        percentileResultDiv.textContent = ""; // Clear previous percentile

        const selectedGender = genderFilterSelect.value;
        let filteredData = allResultsData;

        if (selectedGender !== "All") {
            filteredData = allResultsData.filter(d => d["Gender Category"] === selectedGender);
        }

        if (filteredData.length === 0) {
            Plotly.purge(plotDiv); // Clear existing plot
            percentileResultDiv.textContent = `No data available for "${selectedGender}".`;
            return;
        }

        const finishTimesMinutes = filteredData.map(d => d.Finish_Minutes);

        const trace = {
            x: finishTimesMinutes,
            type: 'histogram',
            xbins: {
                size: 5 // Bin size of 5 minutes, adjust as needed
            },
            marker: {
                color: 'rgb(100,150,200)',
            },
            name: 'Finish Times'
        };

        const layout = {
            title: `GÃ¶teborgsvarvet 2025: Finish Time Distribution (${selectedGender})`,
            xaxis: {
                title: 'Finish Time (Minutes)',
                // Add tick formatting if desired, e.g., to show HH:MM
            },
            yaxis: {
                title: 'Number of Runners'
            },
            bargap: 0.05,
            shapes: [] // To hold the vertical line for user's time
        };

        const userTimeStr = userTimeInput.value;
        const userTimeInMinutes = parseTimeToMinutes(userTimeStr);

        if (userTimeInMinutes !== null) {
            layout.shapes.push({
                type: 'line',
                x0: userTimeInMinutes,
                y0: 0,
                x1: userTimeInMinutes,
                y1: 1,
                yref: 'paper', // Makes y1 relative to plot height (0 to 1)
                line: {
                    color: 'red',
                    width: 2,
                    dash: 'dashdot'
                }
            });

            // Calculate percentile
            // Percentile: % of runners in this group who finished AT or BEFORE your time (lower is better)
            const runnersAtOrBeforeUserTime = finishTimesMinutes.filter(t => t <= userTimeInMinutes).length;
            const totalRunnersInGroup = finishTimesMinutes.length;
            
            if (totalRunnersInGroup > 0) {
                const percentile = (runnersAtOrBeforeUserTime / totalRunnersInGroup) * 100;
                const fasterThanPercent = 100 - percentile;

                percentileResultDiv.innerHTML = `Your time (${userTimeStr}) places you in the <strong>${percentile.toFixed(1)}th percentile</strong> within the "${selectedGender}" group.<br>
                                                 This means ${percentile.toFixed(1)}% of runners in this group finished at or before your time.
                                                 You were faster than ${fasterThanPercent.toFixed(1)}% of runners in this group. (A lower percentile value is better).`;
                if (userTimeInMinutes < Math.min(...finishTimesMinutes)) {
                     percentileResultDiv.innerHTML += "<br>Wow, you're faster than everyone in this filtered group!";
                } else if (userTimeInMinutes > Math.max(...finishTimesMinutes)) {
                     percentileResultDiv.innerHTML += "<br>Your time is slower than everyone in this filtered group.";
                }
            } else {
                percentileResultDiv.textContent = "Cannot calculate percentile with no data in the selected group.";
            }

        } else if (userTimeStr.trim() !== "") {
            // User entered something, but it was invalid
            errorMessageDiv.textContent = "Invalid time format. Please use HH:MM:SS (e.g., 01:45:30) or MM:SS (e.g., 45:30).";
        }


        Plotly.newPlot(plotDiv, [trace], layout, {responsive: true});
    }

    // Event listeners
    // userTimeInput.addEventListener('input', updatePlot); // Updates on every keystroke, might be too much
    genderFilterSelect.addEventListener('change', updatePlot);

    // Initialize when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', fetchDataAndInitialize);

</script>
